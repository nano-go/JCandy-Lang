var FLAG_CONTINUE = Object()
var FLAG_BREAK = Object()

class Stream {
	fun init(iterable) {
		this.iterable = iterable
		this.eval = lambda e -> e
	}
	
	fun _eval(fn) {
		var eval = this.eval
		return lambda e -> {
			e = eval(e)
			if (e == FLAG_CONTINUE || e == FLAG_BREAK) {
				return e
			}
			return fn(e)
		}
	}
	
	fun collect(collector) {
		return collector(this)
	}

	fun filter(accepter) {
		this.eval = this._eval(lambda e -> {
			if (accepter(e)) {
				return e
			}
			return FLAG_CONTINUE
		})
		return this
	}
	
	fun map(convertor) {
		this.eval = this._eval(convertor)
		return this
	}
	
	fun limit(n) {
		this.eval = this._eval(lambda e -> {
			if (n <= 0) {
				return FLAG_BREAK
			}
			n -= 1
			return e
		})
		return this
	}
	
	fun skip(n) {
		this.eval = this._eval(lambda e -> {
			if (n > 0) {
				n -= 1
				return FLAG_CONTINUE
			}
			return e
		})
		return this
	}
	
	fun foreach(f) {
		var iterable = this.iterable
		var eval = this.eval
		for (e in iterable) {
			e = eval(e)
			if (e == FLAG_CONTINUE) {
				continue
			}
			if (e == FLAG_BREAK) {
				break
			}
			f(e)
		}
		return this
	}
}

fun arrayCollector(stream) {
	var arr = []
	stream.foreach(lambda e -> arr.append(e))
	return arr
}

fun averageCollector(stream) {
	var val = 0.0
	var n = 0
	stream.foreach(lambda e -> {
		val += e
		n += 1
	})
	return val / n
}